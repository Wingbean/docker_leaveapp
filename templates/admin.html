{% extends "base.html" %}
{% block content %}
<h2 class="text-center mb-4">จัดการผู้ใช้</h2>

<!-- แถบเครื่องมือ: ค้นหา / กรอง / Export -->
<div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
  <div class="d-flex gap-2">
    <input id="userSearch" class="form-control" placeholder="ค้นหาชื่อหรืออีเมล" oninput="filterUsers()">
    <select id="verifyFilter" class="form-select w-auto" onchange="filterUsers()">
      <option value="">ทั้งหมด</option>
      <option value="verified">ยืนยันแล้ว</option>
      <option value="unverified">ยังไม่ยืนยัน</option>
    </select>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('export_users_csv') }}">Export CSV</a>
  </div>
</div>

<div class="table-responsive">
  <table class="table table-striped table-bordered align-middle" id="usersTable">
    <thead class="table-dark">
      <tr>
        <th>#</th>
        <th>ชื่อผู้ใช้</th>
        <th>อีเมล</th>
        <th>ยืนยันอีเมล</th>
        <th>สถานะ</th>
        <th class="text-center">การจัดการ</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
        <tr data-username="{{ user.username|lower }}" data-email="{{ user.email|lower }}" data-verified="{{ 1 if user.is_verified else 0 }}">
          <td>{{ loop.index }}</td>
          <td>{{ user.username }}</td>
          <td>{{ user.email }}</td>
          <td>
            {% if user.is_verified %}
              <span class="badge text-bg-success">ยืนยันแล้ว</span>
            {% else %}
              <span class="badge text-bg-secondary">ยังไม่ยืนยัน</span>
            {% endif %}
          </td>
          <td>
            {% if user.is_admin %}
              <span class="badge text-bg-primary">ผู้ดูแล</span>
            {% else %}
              <span class="badge text-bg-light text-dark">ผู้ใช้ทั่วไป</span>
            {% endif %}
          </td>
          <td class="text-center">
            {% if not user.is_verified %}
              <form method="post" action="{{ url_for('admin_resend_verify', user_id=user.id) }}" class="d-inline">
                {# <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> #}
                <button type="submit" class="btn btn-outline-info btn-sm">ส่งลิงก์ยืนยัน</button>
              </form>
            {% endif %}

            {% if user.id != current_user.id %}
              <form method="post" action="{{ url_for('admin_force_reset', user_id=user.id) }}" class="d-inline"
                    onsubmit="return confirm('ออกลิงก์รีเซ็ตรหัสผ่านให้ผู้ใช้นี้?');">
                {# <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> #}
                <button type="submit" class="btn btn-outline-warning btn-sm">ออกลิงก์รีเซ็ต</button>
              </form>
            {% endif %}

            {% if user.id != current_user.id %}
              <form method="post"
                    action="{{ url_for('admin_toggle_admin', user_id=user.id) }}"
                    onsubmit="return confirm({{ (('ถอนสิทธิ์แอดมิน' if user.is_admin else 'เลื่อนเป็นแอดมิน') ~ ' สำหรับผู้ใช้นี้?') | tojson }});">
                <button type="submit" class="btn btn-outline-secondary btn-sm">
                  {{ "ถอนแอดมิน" if user.is_admin else "เลื่อนเป็นแอดมิน" }}
                </button>
              </form>
            {% endif %}

            {% if not user.is_admin and user.id != current_user.id %}
              <form method="post" action="{{ url_for('delete_user', user_id=user.id) }}" class="d-inline"
                    onsubmit="return confirm('คุณแน่ใจหรือไม่ที่จะลบผู้ใช้นี้?');">
                {# <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> #}
                <button type="submit" class="btn btn-danger btn-sm">ลบ</button>
              </form>
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<a href="{{ url_for('index') }}" class="btn btn-secondary mt-3">กลับหน้าแรก</a>

<!-- filter แบบ client-side -->
<script>
  function filterUsers() {
    const q = (document.getElementById('userSearch').value || '').trim().toLowerCase();
    const f = document.getElementById('verifyFilter').value;
    const rows = document.querySelectorAll('#usersTable tbody tr');
    rows.forEach(tr => {
      const u = tr.dataset.username;
      const e = tr.dataset.email;
      const v = tr.dataset.verified; // "1" or "0"
      const matchText = !q || u.includes(q) || e.includes(q);
      const matchVerify = !f || (f === 'verified' && v === '1') || (f === 'unverified' && v === '0');
      tr.style.display = (matchText && matchVerify) ? '' : 'none';
    });
  }
</script>
{% endblock %}
