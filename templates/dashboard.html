{% extends "base.html" %}
{% block content %}
<h2 class="mb-4">üìä Dashboard ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h2>

<!-- [NEW @line~6] ‡πÄ‡∏û‡∏¥‡πà‡∏° div ‡∏´‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡∏•‡∏ö height ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å canvas -->
<div class="chart-wrap mb-3" style="position:relative; height: 360px;">
  <canvas id="leaveChart"></canvas>
</div>

<!-- [CHANGE] ‡πÇ‡∏´‡∏•‡∏î Chart.js ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô UMD (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ES5/‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ) ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>

<script>
  (function () {
    // [CHANGE] ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Jinja ‡∏î‡πâ‡∏ß‡∏¢ tojson (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏î‡∏¥‡∏ö)
    const labels = {{ monthly_summary | map(attribute='month') | list | tojson }};
    const values = {{ monthly_summary | map(attribute='total') | list | tojson }};

    // [ADD] ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô canvas (‡∏Å‡∏±‡∏ô error/‡∏Å‡∏£‡∏≤‡∏ü‡πÇ‡∏•‡πà‡∏á)
    if (!Array.isArray(labels) || labels.length === 0) {
      const c = document.getElementById('leaveChart');
      if (c) c.replaceWith(Object.assign(document.createElement('div'), {
        className: 'alert alert-info',
        role: 'alert',
        innerText: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
      }));
      return;
    }

    // [ADD] ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏ò‡∏µ‡∏° Bootstrap (var(--bs-primary)) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏∏‡∏î‡πÇ‡∏ó‡∏ô‡πÄ‡∏ß‡πá‡∏ö
    function bsPrimaryRGBA(alpha) {
      const v = getComputedStyle(document.documentElement)
        .getPropertyValue('--bs-primary')
        .trim(); // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô rgb(r, g, b) ‡∏´‡∏£‡∏∑‡∏≠ #hex (‡∏ö‡∏ô‡∏ö‡∏≤‡∏á‡∏ò‡∏µ‡∏°)
      // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á rgb() ‡πÅ‡∏•‡∏∞ hex ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ ‡πÜ
      let r=13,g=110,b=253; // fallback Bootstrap primary
      if (v.startsWith('rgb')) {
        const m = v.match(/\d+/g);
        if (m && m.length >= 3) [r,g,b] = m.map(Number);
      } else if (v.startsWith('#')) {
        const hex = v.replace('#','');
        if (hex.length === 6) {
          r = parseInt(hex.slice(0,2),16);
          g = parseInt(hex.slice(2,4),16);
          b = parseInt(hex.slice(4,6),16);
        }
      }
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    // [ADD] ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢‡πÉ‡∏ô tooltip/‡πÅ‡∏Å‡∏ô
    const thNumber = new Intl.NumberFormat('th-TH');

    const ctx = document.getElementById('leaveChart').getContext('2d');
    // [CHANGE] ‡πÄ‡∏û‡∏¥‡πà‡∏° options: responsive, title, grid, tooltip ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° ‡πÅ‡∏•‡∏∞ maintainAspectRatio=false ‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤',
          data: values,
          backgroundColor: bsPrimaryRGBA(0.5),   // ‡∏™‡∏µ‡πÇ‡∏õ‡∏£‡πà‡∏á‡∏™‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤
          borderColor: bsPrimaryRGBA(0.9),       // ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô
          borderWidth: 1,
          maxBarThickness: 40                     // [ADD] ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ó‡πà‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏î‡∏µ
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,               // ‡πÉ‡∏´‡πâ canvas ‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏° container (height="100" ‡∏¢‡∏±‡∏á‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏∏‡∏°)
        resizeDelay: 150,                         // [ADD] ‡∏•‡∏î‡∏Å‡∏≤‡∏£ resize ‡∏ñ‡∏µ‡πà ‡πÜ ‡∏Å‡∏±‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏õ
        plugins: {
          title: {
            display: true,
            text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (YYYY-MM)'
          },
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: (ctx) => ` ${thNumber.format(ctx.raw)} ‡∏ß‡∏±‡∏ô`
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0,
              callback: (v) => thNumber.format(v)
            },
            grid: { color: 'rgba(0,0,0,0.08)' }
          },
          x: {
            grid: { display: false }
          }
        },
        animation: {
          duration: 300                           // [ADD] ‡πÄ‡∏£‡πá‡∏ß ‡∏•‡∏∑‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏´‡∏ô‡πà‡∏ß‡∏á
        }
      }
    });
  })();
</script>

<!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
<h4 class="mt-5">üßæ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô</h4>
<table class="table table-striped">
  <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤</th></tr></thead>
  <tbody>
    {# [KEEP] ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•; ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ß‡πà‡∏≤‡∏á ‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏î‡πâ #}
    {% for row in person_summary %}
      <tr><td>{{ row.name }}</td><td>{{ row.total }}</td></tr>
    {% else %}
      <tr><td colspan="2" class="text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
